name: Auto-Create PR to Dev

on:
  push:
    branches:
      - 'feature-**'
      - 'fix-**'
      - 'docs-**'
      - 'refactor-**'

permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  create-pr:
    name: Create PR to Dev
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check if PR already exists
        id: check-pr
        uses: actions/github-script@v7
        with:
          script: |
            const branch = context.ref.replace('refs/heads/', '');

            const { data: pulls } = await github.rest.pulls.list({
              owner: context.repo.owner,
              repo: context.repo.repo,
              head: `${context.repo.owner}:${branch}`,
              base: 'dev',
              state: 'open',
            });

            if (pulls.length > 0) {
              console.log(`PR already exists: #${pulls[0].number}`);
              core.setOutput('pr_exists', 'true');
              core.setOutput('pr_number', pulls[0].number);
            } else {
              console.log('No existing PR found');
              core.setOutput('pr_exists', 'false');
            }

      - name: Extract issue number
        id: extract-issue
        if: steps.check-pr.outputs.pr_exists == 'false'
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"

          # Extract issue number from branch name (format: {type}-{number}-{slug})
          if [[ $BRANCH_NAME =~ ^(feature|fix|docs|refactor)-([0-9]+)- ]]; then
            ISSUE_NUMBER="${BASH_REMATCH[2]}"
            echo "issue_number=$ISSUE_NUMBER" >> $GITHUB_OUTPUT
            echo "has_issue=true" >> $GITHUB_OUTPUT
          else
            echo "has_issue=false" >> $GITHUB_OUTPUT
          fi

      - name: Get issue details
        id: get-issue
        if: steps.check-pr.outputs.pr_exists == 'false' && steps.extract-issue.outputs.has_issue == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const issueNumber = ${{ steps.extract-issue.outputs.issue_number }};

            try {
              const { data: issue } = await github.rest.issues.get({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
              });

              core.setOutput('title', issue.title);
              core.setOutput('body', issue.body || '');
              core.setOutput('labels', issue.labels.map(l => l.name).join(','));
            } catch (error) {
              console.log(`Could not fetch issue #${issueNumber}: ${error.message}`);
              core.setOutput('title', '');
            }

      - name: Determine PR labels
        id: determine-labels
        if: steps.check-pr.outputs.pr_exists == 'false'
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"

          # Determine labels based on branch prefix
          if [[ $BRANCH_NAME == feature-* ]]; then
            echo "labels=feature,enhancement" >> $GITHUB_OUTPUT
          elif [[ $BRANCH_NAME == fix-* ]]; then
            echo "labels=bug,fix" >> $GITHUB_OUTPUT
          elif [[ $BRANCH_NAME == docs-* ]]; then
            echo "labels=documentation" >> $GITHUB_OUTPUT
          elif [[ $BRANCH_NAME == refactor-* ]]; then
            echo "labels=refactoring" >> $GITHUB_OUTPUT
          else
            echo "labels=" >> $GITHUB_OUTPUT
          fi

      - name: Create PR title
        id: create-title
        if: steps.check-pr.outputs.pr_exists == 'false'
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"

          # If we have issue title, use it; otherwise, create from branch
          if [ -n "${{ steps.get-issue.outputs.title }}" ]; then
            TITLE="${{ steps.get-issue.outputs.title }}"
          else
            # Create title from branch name
            SLUG=$(echo "$BRANCH_NAME" | sed -E 's/^(feature|fix|docs|refactor)-[0-9]+-//' | tr '-' ' ')
            TYPE=$(echo "$BRANCH_NAME" | sed -E 's/-[0-9]+-.*//')

            case $TYPE in
              feature) PREFIX="feat" ;;
              fix) PREFIX="fix" ;;
              docs) PREFIX="docs" ;;
              refactor) PREFIX="refactor" ;;
              *) PREFIX="chore" ;;
            esac

            TITLE="$PREFIX: $SLUG"
          fi

          echo "title=$TITLE" >> $GITHUB_OUTPUT

      - name: Create PR body
        id: create-body
        if: steps.check-pr.outputs.pr_exists == 'false'
        run: |
          BRANCH_NAME="${GITHUB_REF#refs/heads/}"

          # Build PR body
          BODY="## Auto-Generated PR

This PR was automatically created from branch \`$BRANCH_NAME\`.

"

          # Add issue link if available
          if [ "${{ steps.extract-issue.outputs.has_issue }}" == "true" ]; then
            BODY+="**Linked Issue:** #${{ steps.extract-issue.outputs.issue_number }}

"
          fi

          # Add issue body if available
          if [ -n "${{ steps.get-issue.outputs.body }}" ]; then
            BODY+="## Issue Description

${{ steps.get-issue.outputs.body }}

"
          fi

          BODY+="---

**Please review the PR template checklist below and fill in the details.**"

          # Save to file for multiline handling
          echo "$BODY" > /tmp/pr-body.txt
          echo "body_file=/tmp/pr-body.txt" >> $GITHUB_OUTPUT

      - name: Create pull request
        if: steps.check-pr.outputs.pr_exists == 'false'
        id: create-pr-step
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const branch = context.ref.replace('refs/heads/', '');

            const title = '${{ steps.create-title.outputs.title }}';
            const bodyFile = '${{ steps.create-body.outputs.body_file }}';
            const body = fs.readFileSync(bodyFile, 'utf8');
            const labels = '${{ steps.determine-labels.outputs.labels }}'.split(',').filter(l => l);

            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              head: branch,
              base: 'dev',
            });

            console.log(`Created PR #${pr.number}: ${pr.html_url}`);

            // Add labels
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: labels,
              });
            }

            // Link to issue if available
            if ('${{ steps.extract-issue.outputs.has_issue }}' === 'true') {
              const issueNumber = ${{ steps.extract-issue.outputs.issue_number }};

              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: issueNumber,
                body: `ðŸ”— PR created: #${pr.number}\n\nReview and merge when ready.`,
              });
            }

            core.setOutput('pr_number', pr.number);
            core.setOutput('pr_url', pr.html_url);

      - name: Comment on existing PR
        if: steps.check-pr.outputs.pr_exists == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const prNumber = ${{ steps.check-pr.outputs.pr_number }};

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: prNumber,
              body: `âœ… New commits pushed to this PR. Review updated.`,
            });

            console.log(`Updated existing PR #${prNumber}`);
