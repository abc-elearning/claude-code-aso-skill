name: Claude Main Branch Check

on:
  pull_request:
    types: [opened, synchronize]
    branches: [main]

permissions:
  contents: read
  pull-requests: write
  issues: read

jobs:
  main-check:
    name: Claude Release Validation
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR details
        id: pr-details
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            // Check if this is from dev branch
            const isFromDev = pr.head.ref === 'dev';
            core.setOutput('is_from_dev', isFromDev);

            if (!isFromDev) {
              core.setOutput('error', `PRs to main must come from dev branch. Current head: ${pr.head.ref}`);
            }

      - name: Block non-dev PRs
        if: steps.pr-details.outputs.is_from_dev == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `❌ **Invalid PR Source**\n\nPRs to \`main\` must come from the \`dev\` branch only.\n\n**Current source:** \`${pr.head.ref}\`\n\nPlease:\n1. Close this PR\n2. Merge your changes to \`dev\` first\n3. Create a release PR from \`dev\` to \`main\``,
            });

            core.setFailed('${{ steps.pr-details.outputs.error }}');

      - name: Run Claude minimal check
        if: steps.pr-details.outputs.is_from_dev == 'true'
        id: claude-check
        uses: anthropics/claude-code-action@v1
        with:
          claude_code_oauth_token: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
          prompt: |
            REPO: ${{ github.repository }}
            PR NUMBER: ${{ github.event.pull_request.number }}

            This is a RELEASE PR from dev → main. Perform a MINIMAL final validation:

            **Critical Checks Only:**

            1. **CHANGELOG.md:**
               - Is CHANGELOG.md updated with new version?
               - Does [Unreleased] section have content moved to a versioned section?
               - Is the version number following semver (MAJOR.MINOR.PATCH)?

            2. **Version Consistency:**
               - If pyproject.toml exists, is version bumped?
               - Does version in CHANGELOG match version in pyproject.toml?

            3. **Breaking Changes:**
               - Are breaking changes clearly documented?
               - Is migration guide provided if needed?

            4. **Quality Gates:**
               - Did all dev branch quality checks pass?
               - Use `gh pr view ${{ github.event.pull_request.number }} --json statusCheckRollup` to verify

            **DO NOT:**
            - Re-review code (already reviewed on dev)
            - Check for bugs (already tested on dev)
            - Perform security scans (already done on dev)
            - Review individual commits (trust dev validation)

            **Response Format:**
            If checks pass:
            ```
            ✅ Release validation passed
            - CHANGELOG.md: ✅ Updated with version X.Y.Z
            - Version consistency: ✅ Matches across files
            - Breaking changes: ✅ Documented / ⚠️ None found
            - Quality gates: ✅ All passed on dev

            **Recommendation:** APPROVE for merge
            ```

            If checks fail:
            ```
            ❌ Release validation failed
            - Issue 1: Description
            - Issue 2: Description

            **Recommendation:** REQUEST CHANGES
            ```

            Use `gh pr review` with your Bash tool to approve or request changes.

          claude_args: '--allowed-tools "Bash(gh *)"'

      - name: Validation summary
        if: always()
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            const checkStatus = '${{ steps.claude-check.outcome }}';

            let emoji = '✅';
            let status = 'passed';
            let message = 'Claude release validation completed successfully.';

            if (checkStatus !== 'success') {
              emoji = '⚠️';
              status = 'completed with warnings';
              message = 'Claude release validation completed. Please review feedback above.';
            }

            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `${emoji} **Claude Main Branch Check ${status}**\n\n${message}\n\nThis is a minimal final validation before release. Most quality checks were already performed on the \`dev\` branch.`,
            });
